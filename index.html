<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>LUCKY 7</title>

  <meta name="theme-color" content="#17173A" />
  <link rel="apple-touch-icon" href="icon-512.png">

  <style>
    :root { --bg:#17173A; --fg:#ffffff; --card:#ffffff; --accent:#ffffff; }

    /* Layout */
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: var(--bg); color: var(--fg);
      font-family: Arial, sans-serif;
      -webkit-text-size-adjust: none;
      touch-action: manipulation;
      overscroll-behavior: none;
      overflow: hidden; /* only .app may scroll */
    }
    body.modal-open { overflow: hidden; height: 100%; }

    .app {
      height: 100dvh;
      display: flex; flex-direction: column;
      overflow: auto; /* single scrollbar if needed */
      -webkit-overflow-scrolling: touch;
      padding:
        env(safe-area-inset-top)
        env(safe-area-inset-right)
        env(safe-area-inset-bottom)
        env(safe-area-inset-left);
    }
    .app-inner {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      padding: 20px; box-sizing: border-box; text-align: center;
    }

    .logo { width: clamp(160px, 30vw, 360px); height: auto; margin: 0 auto 18px; }

    .cards {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
    }

    .card-container { perspective: 1000px; }

    .card-inner {
      width: clamp(90px, 12vw, 120px);
      height: clamp(150px, 21vw, 200px);
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
      cursor: pointer;
    }
    .card.flipped .card-inner { transform: rotateY(180deg); cursor: default; }

    .card-face {
      position: absolute; width: 100%; height: 100%;
      border-radius: 12px; backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: clamp(28px, 4vw, 48px); font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .card-front { background: royalblue; border: 3px solid #fff; box-sizing: border-box; }
    .card-back  { background: var(--card); color: #000; border: 3px solid #fff; box-sizing: border-box; transform: rotateY(180deg); position: relative; }

    /* keep the back face fully visible immediately on bust */
    .card-back.show-now {
      opacity: 1 !important;
      transition-delay: 0s !important;
    }

    .position-label { font-size:clamp(14px,2vw,18px); margin-top:6px; color:var(--fg); }

    .button-row { display:flex; justify-content:center; gap:16px; margin-top:15px; }
    #howToPlayButton {
      padding:8px 20px; min-width:120px; font-size:16px; font-weight:bold;
      border-radius:6px; background:var(--bg); color:var(--fg);
      border:2px solid var(--accent); cursor:pointer;
    }
    #howToPlayButton:hover{ background:#1e1e45; }

    .scoreboard{ display:flex; justify-content:center; gap:20px; margin-top:15px; }
    .scorebox{ background:var(--card); color:#000; padding:10px 20px; border-radius:8px; font-size:18px; font-weight:bold; min-width:100px; }

    /* Win overlay */
    .win-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10001; pointer-events:none; }
    .win-overlay .text{ font-size:clamp(72px,16vw,220px); font-weight:900; color:#FFD700;
      text-shadow:-4px -4px 0 #000,4px -4px 0 #000,-4px 4px 0 #000,4px 4px 0 #000,0 -5px 0 #000,0 5px 0 #000,-5px 0 0 #000,5px 0 0 #000;
      animation:winTextFlash .25s ease-in-out infinite alternate; }
    @keyframes winTextFlash{ 0%{transform:scale(1)} 100%{transform:scale(1.12)} }
    .win-overlay.show{ display:flex; }

    .copyright{ font-size:1em; margin-top:10px; opacity:.8; }

    /* Confetti canvas (above game, below overlay text) */
    canvas.confetti { position:fixed; inset:0; pointer-events:none; z-index:10000; }

    /* Fullscreen toggle */
    .fs-toggle{ position:fixed; top:10px; right:10px; width:34px; height:34px; line-height:30px; text-align:center; font-size:20px; font-weight:900; color:#fff; background:rgba(0,0,0,.35); border:2px solid #fff; border-radius:8px; cursor:pointer; z-index:10002; backdrop-filter:blur(2px); }
    .fs-toggle:active{ transform:scale(.96); }

    /* ================= Promo modal (base = desktop card) ================= */
    #promoModal{
      display:none; position:fixed; z-index:10050; inset:0;
      background:rgba(0,0,0,.75); backdrop-filter:blur(2px);
      overflow:auto;
    }
    #promoContent{
      background:#1D1D3F; color:#fff;
      margin:32px auto 0;
      padding:20px 22px;
      border-radius:12px;
      max-width:420px;
      width:calc(100% - 40px);
      text-align:left;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
    }
    #promoContent .ad-hero{
      width:100%;
      height:auto;
      display:block;
      border-radius:8px;
      margin-bottom:12px;
      object-fit:cover;
    }
    .promo-body{ margin-bottom:10px; }
    .promo-actions{
      display:flex; gap:10px; justify-content:center; margin-top:10px;
    }
    .promo-btn{
      flex:1; text-align:center;
      padding:6px 12px;
      font-size:14px;
      font-weight:700;
      border-radius:6px;
      cursor:pointer;
      border:none;
    }
    .promo-btn.learn{ background:#FFD700; color:#000; text-decoration:none; }
    .promo-btn.close{ background:#fff; color:#000; }

    /* ======== Mobile full-viewport version ======== */
    @media (max-width: 640px), (pointer: coarse) {
      #promoContent{
        margin:0;
        padding:0;
        width:100vw;
        max-width:none;
        height:100dvh;
        border-radius:0;
      }
      #promoContent .ad-hero{
        height:60vh;         /* adjust 55–70vh if you prefer */
        border-radius:0;
        margin:0;
        object-fit:cover;    /* fill & crop to edges */
      }
      .promo-body{
        padding:12px 16px;
        overflow:auto;
        flex:1;             /* take remaining space */
      }
      .promo-actions{
        position:sticky;
        bottom:0;
        background:#1D1D3F;
        padding:12px 16px;
        margin:0;
        box-shadow:0 -2px 6px rgba(0,0,0,.35);
      }
    }
    @media (max-height: 640px) {
      #promoContent { margin:0; }
    }

    /* ================= How-to modal ================= */
    #howToPlayModal{ display:none; position:fixed; z-index:10060; inset:0; background:rgba(0,0,0,.75); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; padding:16px; }
    #howToPlayContent{ background:#1D1D3F; color:#fff; padding:20px 22px; border-radius:12px; max-width:420px; width:calc(100% - 40px); text-align:left; box-shadow:0 10px 30px rgba(0,0,0,.35); margin:0; max-height:90vh; overflow:auto; }
    .howto-actions{ text-align:center; margin-top:14px; }
    .howto-actions button{ padding:10px 24px; background:#fff; color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }

    /* Bust effects (calmer) */
    @keyframes bustBackgroundFlash {
      0%{ background:rgba(255,0,0,.25) }
      50%{ background:rgba(255,0,0,.80) }
      100%{ background:rgba(255,0,0,.25) }
    }
    .card.bustFlash .card-back {
      animation: bustBackgroundFlash 0.85s infinite;
      color:#fff;
      opacity: 1 !important;
      transition-delay: 0s !important;
    }

    @keyframes bustPulseCard {
      0% { transform: scale(1); }
      50%{ transform: scale(1.06); }
      100%{ transform: scale(1); }
    }
    .card.pulse { animation: bustPulseCard 1s ease-in-out infinite; }

    .bust-label {
      position:absolute; left:6px; right:6px; text-align:center;
      font-weight:900; color:#fff; letter-spacing:.08em;
      text-shadow:0 2px 4px rgba(0,0,0,.6); pointer-events:none;
      font-size:clamp(16px,2.5vw,22px);
    }
    .bust-label.top{ top:6px } .bust-label.bottom{ bottom:6px }
  </style>
</head>

<body>
  <div class="app">
    <div class="app-inner">
      <img class="logo" src="logo.png?v=3" alt="Lucky 7"/>
      <div class="cards" id="cardContainer"></div>

      <div class="button-row">
        <button id="howToPlayButton" onclick="showHowToPlay()">How to Play</button>
      </div>

      <div class="scoreboard">
        <div class="scorebox">Won: <span id="winCount">0</span></div>
        <div class="scorebox">Lost: <span id="loseCount">0</span></div>
      </div>

      <div class="copyright">© Kev Shirreffs 2025</div>
    </div>
  </div>

  <!-- Fullscreen toggle -->
  <button id="fsToggle" class="fs-toggle" aria-label="Enter fullscreen" title="Enter fullscreen" hidden>⛶</button>

  <!-- Win overlay -->
  <div id="winOverlay" class="win-overlay"><div class="text">YOU WIN!</div></div>

  <!-- Promo / Ad modal (updated structure) -->
  <div id="promoModal" aria-modal="true" role="dialog">
    <div id="promoContent">
      <!-- Hero image -->
      <a href="https://www.oasisinet.com/" target="_blank" rel="noopener">
        <img class="ad-hero" src="oasis.jpg" alt="Ad">
      </a>

      <!-- Optional middle body (remove if unused) -->
      <div class="promo-body"></div>

      <!-- Actions -->
      <div class="promo-actions">
        <a href="https://www.oasisinet.com/" target="_blank" rel="noopener" class="promo-btn learn">Learn more</a>
        <button id="promoCloseBtn" class="promo-btn close">Close &amp; Play</button>
      </div>
    </div>
  </div>

  <!-- How to Play modal -->
  <div id="howToPlayModal" aria-modal="true" role="dialog">
    <div id="howToPlayContent">
      <h2 style="text-align:center; margin:0 0 10px;">How to Play</h2>
      <p>🎯 You have 7 facedown cards numbered <strong>1 to 7</strong>.</p>
      <p>🔄 The back has numbers 1–7 in random order.</p>
      <p>🃏 Pick any card. That number = next card position.</p>
      <p>🏆 Reveal all 7 without repeats to win.</p>
      <p>❌ If you’re sent to an already-open card, you bust.</p>
      <div class="howto-actions"><button onclick="closeHowToPlay()">Got it!</button></div>
    </div>
  </div>

  <!-- ====== Inline Game Logic (unchanged) ====== -->
  <script>
    /* ========= Confetti ========= */
    (function () {
      const canvas = document.createElement('canvas');
      canvas.className = 'confetti';
      const ctx = canvas.getContext('2d');
      let W=0, H=0, particles=[], running=false, endTime=0, rafId=0;

      function mount() {
        if (!canvas.isConnected) document.body.appendChild(canvas);
        resize();
        window.addEventListener('resize', resize);
      }
      function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
      }
      function spawn(n=6) {
        for (let i=0;i<n;i++){
          particles.push({
            x: Math.random()*W,
            y: -10,
            vx: (Math.random()-0.5)*2,
            vy: 2+Math.random()*3,
            s: 4+Math.random()*6,
            rot: Math.random()*Math.PI,
            vr: (Math.random()-0.5)*0.2,
            shape: Math.random()<0.5 ? 'rect' : 'circle',
            colorIndex: Math.floor(Math.random()*5)
          });
        }
      }
      const COLORS = ['#FFD700','#FF3B3B','#4CAF50','#42A5F5','#FF9800'];

      function step() {
        ctx.clearRect(0,0,W,H);
        particles.forEach(p=>{
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if (p.y > H+20) { p.y = -10; p.x = Math.random()*W; }
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
          ctx.fillStyle = COLORS[p.colorIndex % COLORS.length];
          if (p.shape==='rect') ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s*0.6);
          else { ctx.beginPath(); ctx.arc(0,0,p.s/2,0,Math.PI*2); ctx.fill(); }
          ctx.restore();
        });
      }
      function loop() {
        if (!running) return;
        step();
        if (Date.now() < endTime) {
          spawn(3);
          rafId = requestAnimationFrame(loop);
        } else {
          running = false;
          particles = [];
          ctx.clearRect(0,0,W,H);
          cancelAnimationFrame(rafId);
        }
      }
      window.launchConfetti = function(durationMs=3000) {
        mount();
        endTime = Date.now() + durationMs;
        if (!running) { running = true; loop(); }
      };
    })();

    /* ========= Modals ========= */
    function showPromo(){const m=document.getElementById('promoModal');if(m){m.style.display='block';document.body.classList.add('modal-open');}}
    function closePromo(){const m=document.getElementById('promoModal');if(m){m.style.display='none';document.body.classList.remove('modal-open');sessionStorage.setItem('promoDismissed','1');}}
    document.addEventListener('click',e=>{if(e.target && e.target.id==='promoCloseBtn') closePromo();});
    window.addEventListener('DOMContentLoaded',()=>{if(!sessionStorage.getItem('promoDismissed')) showPromo();});

    (function(){const howto=document.getElementById('howToPlayModal');if(howto) howto.style.display='none';})();
    function showHowToPlay(){const m=document.getElementById('howToPlayModal');if(m) m.style.display='flex';document.body.classList.add('modal-open');}
    function closeHowToPlay(){const m=document.getElementById('howToPlayModal');if(m) m.style.display='none';document.body.classList.remove('modal-open');}
    window.showHowToPlay = showHowToPlay;
    window.closeHowToPlay = closeHowToPlay;

    /* ========= Fullscreen ========= */
    (function(){
      const btn=document.getElementById('fsToggle'); const root=document.documentElement;
      if(!document.fullscreenEnabled) return; btn.hidden=false;
      function update(){const a=!!document.fullscreenElement; btn.title=a?'Exit fullscreen':'Enter fullscreen'; btn.setAttribute('aria-label',btn.title); btn.innerText=a?'×':'⛶';}
      async function toggle(){try{if(!document.fullscreenElement) await root.requestFullscreen(); else await document.exitFullscreen();}catch(e){console.error(e);}finally{update();}}
      btn.addEventListener('click',toggle); document.addEventListener('fullscreenchange',update); update();
    })();

    /* ========= Game ========= */
    const RESTART_DELAY = 3000;
    const FADE_MS = 350;

    let deck = [];             // shuffled numbers 1..7
    let revealed = [];         // booleans
    let gameOver = false;
    let requiredPosition = null; // 1..7 or null for free first pick
    let winCount = 0, loseCount = 0;

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function buildCard(i) {
      const wrap = document.createElement('div');
      wrap.className = 'card-container';

      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.index = String(i);

      const inner = document.createElement('div');
      inner.className = 'card-inner';

      const front = document.createElement('div');
      front.className = 'card-face card-front';

      const back = document.createElement('div');
      back.className = 'card-face card-back';
      const numSpan = document.createElement('span');
      numSpan.className = 'num';
      back.appendChild(numSpan);

      inner.appendChild(front);
      inner.appendChild(back);
      card.appendChild(inner);
      wrap.appendChild(card);

      const label = document.createElement('div');
      label.className = 'position-label';
      label.textContent = String(i + 1);
      wrap.appendChild(label);

      card.addEventListener('click', () => onCardClick(i, card));

      return wrap;
    }

    function startGame() {
      deck = shuffle([1,2,3,4,5,6,7]);
      revealed = Array(7).fill(false);
      gameOver = false;
      requiredPosition = null;

      document.getElementById('winOverlay').classList.remove('show');

      const cont = document.getElementById('cardContainer');
      cont.innerHTML = '';
      for (let i = 0; i < 7; i++) cont.appendChild(buildCard(i));
    }

    function revealBackText(cardEl, value, immediate=false) {
      const back = cardEl.querySelector('.card-back');
      if (!back) return;
      const num = back.querySelector('.num') || (()=>{const s=document.createElement('span');s.className='num';back.appendChild(s);return s;})();
      num.textContent = String(value);
      if (immediate) back.classList.add('show-now');
      else back.classList.remove('show-now');
    }

    function onCardClick(index, cardEl) {
      if (gameOver) return;
      if (requiredPosition !== null && index !== requiredPosition - 1) return;
      if (revealed[index]) return;

      cardEl.classList.add('flipped');
      revealed[index] = true;

      const value = deck[index];
      setTimeout(() => revealBackText(cardEl, value, false), 350);

      if (revealed.every(Boolean)) { return handleWin(); }

      requiredPosition = value;
      if (revealed[requiredPosition - 1]) {
        return handleBust(index);
      }
    }

    function ensureBustLabels(backEl) {
      if (!backEl.querySelector('.bust-label.top')) {
        const t=document.createElement('div'); t.className='bust-label top'; t.textContent='BUST'; backEl.appendChild(t);
      }
      if (!backEl.querySelector('.bust-label.bottom')) {
        const b=document.createElement('div'); b.className='bust-label bottom'; b.textContent='BUST'; backEl.appendChild(b);
      }
    }

    function handleBust(clickedIndex) {
      gameOver = true;
      loseCount++;
      document.getElementById('loseCount').textContent = String(loseCount);

      const cards = document.querySelectorAll('.card');
      const card = cards[clickedIndex];
      if (card) {
        const back = card.querySelector('.card-back');
        if (back) {
          const num = back.querySelector('.num') || (()=>{const s=document.createElement('span');s.className='num';back.appendChild(s);return s;})();
          if (!num.textContent) num.textContent = String(deck[clickedIndex]);
          back.classList.add('show-now');
          ensureBustLabels(back);
        }
        card.classList.add('flipped', 'bustFlash', 'pulse');
      }

      const cont = document.getElementById('cardContainer');
      setTimeout(() => cont.classList.add('fade-out'), RESTART_DELAY - FADE_MS);
      setTimeout(() => { cont.classList.remove('fade-out'); startGame(); }, RESTART_DELAY);
    }

    function handleWin() {
      gameOver = true;
      winCount++;
      document.getElementById('winCount').textContent = String(winCount);

      document.querySelectorAll('.card').forEach((c, i) => {
        c.classList.add('flipped');
        revealBackText(c, deck[i], true);
      });

      document.getElementById('winOverlay').classList.add('show');
      if (typeof window.launchConfetti === 'function') window.launchConfetti(3000);

      const cont = document.getElementById('cardContainer');
      setTimeout(() => cont.classList.add('fade-out'), RESTART_DELAY - FADE_MS);
      setTimeout(() => {
        document.getElementById('winOverlay').classList.remove('show');
        cont.classList.remove('fade-out');
        startGame();
      }, RESTART_DELAY);
    }

    // Boot it up
    startGame();
  </script>
</body>
</html>
